name: Create Draft Release

on:
    push:
        branches: ["main", "fix-release-actions"]

    workflow_dispatch:

jobs:
    create-build-artifacts:
        if: startsWith(github.event.head_commit.message, 'Release:')
        uses: ./.github/workflows/create-build-artifacts.yml
        secrets: inherit

    create-release:
        if: startsWith(github.event.head_commit.message, 'Release:')
        needs: ["create-build-artifacts"]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - uses: actions/download-artifact@v3
              id: download
              with:
                  path: build

            - run: ls -lr ${{ steps.download.outputs.download-path }}

            - run: |
                  chmod a+x scripts/create-release.sh
                  scripts/create-release.sh ${{ steps.download.outputs.download-path }}/databricks*/*.vsix
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
