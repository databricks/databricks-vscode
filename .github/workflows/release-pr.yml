name: Release PR

on:
    workflow_dispatch:
    pull_request:
        branch: [main]

jobs:
    generate-changelog:
        runs-on: "macos-latest"
        strategy:
            matrix:
                package:
                    [
                        packages/databricks-vscode,
                        packages/databricks-sdk,
                        packages/databricks-vscode-types,
                        ".",
                    ]
                node-version: [16.x]
        steps:
            - uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "yarn"

            - run: yarn install --immutable

            - name: Changelog for ${{ matrix.package }}
              run: bash scripts/generate_changelog.sh ${{ matrix.package }} $GITHUB_STEP_SUMMARY

    version-check:
        name: Version Check
        runs-on: "macos-latest"
        steps:
            - uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "yarn"

            - run: yarn install --immutable
            - run: yarn version check
